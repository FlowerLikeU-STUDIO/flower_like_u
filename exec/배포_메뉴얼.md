# ë°°í¬ ë©”ë‰´ì–¼

## ëª©ì°¨

0. ë°©í™”ë²½ ì„¤ì •

1. Docker, Jenkins ì„¤ì¹˜
2. DB ì„¤ì •
3. Nginx ì„¤ì¹˜ ë° SSL ì¸ì¦ì„œ
4. BackEnd - API ì„œë²„
5. BackEnd - Socket ì„œë²„
6. FrontEnd - Next.js
7. Nginx ì„¤ì •



### 0. ë°©í™”ë²½ ì„¤ì •

**ssh í¬íŠ¸ 22ë²ˆ í—ˆìš©**

```shell
# SSH í¬íŠ¸ 22ë²ˆ ì˜¤í”ˆ(í—ˆìš©): TCP/UDP 22ë²ˆ í¬íŠ¸ë¥¼ ëª¨ë‘ í—ˆìš©
sudo ufw allow ssh
# ìš°ë¶„íˆ¬ ë°©í™”ë²½(UFW) í™œì„±í™”
sudo ufw enable
```



### 1. Docker, Jenkins ì„¤ì¹˜

#### Docker

**Set up the repository**

1-1. `apt` íŒ¨í‚¤ì§€ update

```shell
sudo apt-get update
```

1-2. `apt`ê°€ HTTPSë¥¼ í†µí•´ repositoryë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡  íŒ¨í‚¤ì§€ ì„¤ì¹˜

```shell
sudo apt-get install \
    ca-certificates \
    curl \
    gnupg \
    lsb-release
```

2. Dockerâ€™s official GPG key ì¶”ê°€

   âœ” GPG key

   * **GPG** : GNU Privacy Guard (GnuPG)ì˜ ì¤„ì„ë§ë¡œì„œ ë°°í¬ íŒŒì¼ì˜ ì¸ì¦ì„ í™•ì¸í•˜ëŠ”ë° ì‚¬ìš©ë˜ëŠ” ììœ  ì†Œí”„íŠ¸ì›¨ì–´ íŒ¨í‚¤ì§€

   ```shell
   sudo mkdir -p /etc/apt/keyrings
   curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
   ```

3. ë‹¤ìŒ commandë¥¼ í†µí•´ repository set up

   ```shell
   echo \
     "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
     $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
   ```



**Install Docker Engine**

`apt` íŒ¨í‚¤ì§€ update

```shell
sudo apt-get update
```

ê°€ì¥ ìµœì‹  ë²„ì „ì„ ì„¤ì¹˜í•˜ê³  ì‹¤í–‰

```shell
sudo apt-get install docker-ce docker-ce-cli containerd.io docker-compose-plugin
```

**âœ” íŠ¹ì • ë²„ì „ì˜ ì„¤ì¹˜ë¥¼ ì›í•˜ëŠ” ê²½ìš°**

ì°¸ê³ : https://docs.docker.com/engine/install/ubuntu/#install-docker-engine ì˜ Specific version

ì„œë²„ì˜ Timezone ë³€ê²½**

```shell
sudo rm /etc/localtime
sudo ln -s /usr/share/zoneinfo/Asia/Seoul /etc/localtime
date
```



**ì„œë²„ì˜ Timezone ë³€ê²½**

```shell
sudo rm /etc/localtime
sudo ln -s /usr/share/zoneinfo/Asia/Seoul /etc/localtime
date
```



#### Jenkins

Java ì„¤ì¹˜

```shell
sudo apt-get update 
sudo apt-get install openjdk-8-jdk
```



**Jenkins ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ**

```shell
docker pull jenkins/jenkins:lts
```

**ğŸš¨ ê¶Œí•œ ë¬¸ì œê°€ ë°œìƒí•œ ê²½ìš°**

```
Got permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker.sock: Post "http://%2Fvar%2Frun%2Fdocker.sock/v1.24/images/create?fromImage=jenkins%2Fjenkins&tag=lts": dial unix /var/run/docker.sock: connect: permission denied
```

ì‚¬ìš©ìê°€ /var/run/docker.sockì„ ì ‘ê·¼í•˜ë ¤ í–ˆìœ¼ë‚˜ ê¶Œí•œì´ ì—†ì–´ ë°œìƒí•˜ëŠ” ë¬¸ì œ

â¡ ì‚¬ìš©ìê°€ root:docker ê¶Œí•œì„ ê°€ì§€ê³  ìˆì–´ì•¼í•œë‹¤.

âœ” rootê¶Œí•œì„ ê°€ì§€ê³  ì‹¤í–‰í•˜ëŠ” ê²ƒì€ ê¶Œì¥ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ, ì‚¬ìš©ìë¥¼ docker groupì— í¬í•¨ì‹œì¼œì£¼ë©´ ëœë‹¤.

```shell
sudo usermod -aG docker $USER
```

**ë§Œì•½** docker groupì´ ì—†ë‹¤ë©´ ìƒì„±í•˜ê³  ìœ„ ëª…ë ¹ì–´ ì‹¤í–‰

```shell
sudo groupadd docker
```



**Jenkins-Docker ì—°ê²°**

```shell
sudo vim Dockerfile
```

**Dockerfile**

```dockerfile
FROM jenkins/jenkins:jdk11

USER root

COPY docker_install.sh /docker_install.sh
RUN chmod +x /docker_install.sh
RUN /docker_install.sh

RUN usermod -aG docker jenkins
USER jenkins
```



**docker.sock íŒŒì¼ì˜ ê¶Œí•œ ë³€ê²½**

```shell
sudo chmod 666 /var/run/docker.sock
```

**image ìƒì„±**

```shell
docker build -t jenkins .
```

**volume mountí•  í´ë” ìƒì„± ë° ê¶Œí•œì„¤ì •**

```shell
mkdir jenkins
sudo chown -R 1000 ./jenkins
```



**Jenkins Container ë„ìš°ê¸°**

```shell
sudo docker run -d --name jenkins \
-v /home/ubuntu/jenkins:/var/jenkins_home \
-v /var/run/docker.sock:/var/run/docker.sock \
-p 9090:8080 \
-e TZ=Asia/Seoul \
jenkins
```



### 2. DB ì„¤ì •

#### MySQL

```shell
docker pull mysql:latest
```

**Docker volume**

```shell
docker volume create mysql-volume
```

**MySQL Container ë„ìš°ê¸°**

```shell
docker run -d --name mysql-container -p 3306:3306 -v mysql-volume:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=ssafy mysql:latest
```

**Container ì ‘ê·¼**

```shell
docker exec -it mysql-container bash
mysql -u root -p
```

âœ” database ìƒì„±

âœ” user ìƒì„±, ê¶Œí•œ ë¶€ì—¬, ë³€ê²½ì‚¬í•­ ì ìš©



#### MongoDB

**docker-composeì™€ .envíŒŒì¼ ì‚¬ìš©**

**docker-compose ì„¤ì¹˜**

```shell
sudo curl -L https://github.com/docker/compose/releases/download/1.25.0\
-rc2/docker-compose-`uname -s`-`uname -m` -o \
/usr/local/bin/docker-compose
```

**docker-compose ì‹¤í–‰ê¶Œí•œ ì¶”ê°€**

```shell
sudo chmod +x /usr/local/bin/docker-compose
```



**docker-compose.yml**

```yaml
version: '3'
services:
    mongodb:
        image: mongo
        ports:
            - "${MONGO_PORT}:27017"
        volumes:
            - /Users/wool/Dev/mongodb:/data/db
        container_name: "mongodb"
        env_file:
            - .env
```

**.env**

```env
## Mongodb
MONGO_HOST=localhost
MONGO_PORT=í¬íŠ¸ë²ˆí˜¸
MONGO_INITDB_ROOT_USERNAME=
MONGO_INITDB_ROOT_PASSWORD=
MONGO_INITDB_DATABASE=
```

**MongoDB Container ë„ìš°ê¸°**

```shell
docker-compose up -d
```



### 3. Nginx ì„¤ì¹˜ ë° SSL ì¸ì¦ì„œ

```shell
sudo apt install nginx
sudo apt update
sudo apt-get install python3-certbot-nginx
sudo certbot --nginx -d ë„ë©”ì¸ëª…
```



**certbot ì¸ì¦ì„œ í™•ì¸**

```shell
sudo certbot certificates
```



**Nginx ì‚­ì œ**

```shell
sudo apt-get purge nginx nginx-common
```



### 4. BackEnd - API ì„œë²„

#### Jenkins ì„œë²„ ì ‘ì†

**Administrator password í™•ì¸**

```shell
sudo docker logs jenkins
```

`http://APIì„œë²„ë„ë©”ì¸:9090/` ì ‘ì†í•˜ì—¬ Administrator passwordì„ ì…ë ¥ â¡ Continue

âœ” Install suggested plugins

âœ” Create First Admin User â¡ Save and Continue

âœ” Instance Configuration â¡ Save and Finish

âœ” Jenkins is ready â¡ Start using Jenkins



#### Jenkins ì„¤ì •

**Manage Credentials**

stores scoped to Jenkinsì—ì„œ domainë¶€ë¶„ì„ í´ë¦­í•œí›„ ì™¼ìª½íƒ­ì—ì„œ add credentialsë¥¼ í´ë¦­

OR

globalì˜¤ë¥¸ìª½ì— í™”ì‚´í‘œë¥¼ ëˆŒëŸ¬ add credentials

**âœ” API token**

* Gitlab > Repository > Setting > Access Tokens

**âœ” gitlab ID**



**Jenkinsê´€ë¦¬ - ì‹œìŠ¤í…œ ì„¤ì •**

âœ” Gitlab

* Connection name
* Gitlab host URL
* Credentials

ì…ë ¥ í›„ Test Connectionìœ¼ë¡œ ì—°ê²° í™•ì¸



**Jenkins ê´€ë¦¬ - í”ŒëŸ¬ê·¸ì¸ ê´€ë¦¬**

**GitLab**

- GitLab
- Generic Webhook Trigger
- Gitlab API
- GitLab Authentication

â¡ install without restart



#### Jenkins Pipeline

ìƒˆë¡œìš´ Item > Pipleline

##### General

**âœ” Gitlab**

**âœ” ì´ ë¹Œë“œëŠ” ë§¤ê°œë³€ìˆ˜ê°€ ìˆìŠµë‹ˆë‹¤.**


**âœ” Build when a change is pushed to GitLab URL:**

**âœ” ê³ ê¸‰ > Secret token â¡ Generate**

* Gitlabê³¼ WebHookì„ ì—°ê²°í•  ë•Œ ì‚¬ìš©



##### Pipeline

**Definition**: Pipeline script from SCM

**SCM**: Git

**Repositories**

* **Repository URL**:https://lab.ssafy.com/s07-final/S07P31B209
* **Crednetials**
* **Branches to build**: */deploy

**Script Path**



#### Jenkinsfile

```jenkinsfile
pipeline {
    agent any

    stages {
        stage('Init') {
            steps {
                sh "docker stop fly_be"
            }
        }
        stage('Backend Dockerizing') {
            steps {
                sh "docker rmi martinflower/fly:fly_be"
                dir('./backend/fly'){
                    sh "pwd"
                    sh "chmod 777 gradlew"
                    sh "./gradlew clean build"
                    sh "docker build -t martinflower/fly:fly_be ."
                }
            }
        }
        stage('Backend : Publish & Deploy') {
            steps {
                sh "echo $PASSWORD | docker login -u $USERNAME --password-stdin"
                sh "docker push martinflower/fly:fly_be"
                sh "docker pull martinflower/fly:fly_be"
                sh "docker run --rm -d --name fly_be -p 8080:8080 martinflower/fly:fly_be"
            }
        }
    }
}
```



#### Dockerfile

```dockerfile
FROM openjdk:8-jdk-alpine
VOLUME /tmp
ARG JAR_FILE=./build/libs/fly-0.0.1-SNAPSHOT.jar
COPY ${JAR_FILE} app.jar
ENTRYPOINT ["java","-jar","/app.jar"]
```



#### GitLab ì—°ë™

Gitlab - Settings - Webhooks

âœ” URL : ì„œë²„url:9090/project/í”„ë¡œì íŠ¸ëª…

âœ” Secret token

âœ” Trigger - Push events

âœ” SSL verification

â¡ Add webhook



### 5. BackEnd - Socket ì„œë²„

#### Jenkinsfile

```jenkinsfile
pipeline {
    agent any

    stages {
        stage('Init') {
            steps {
                sh """
                    docker stop fly_socket
                """
            }
        }
        stage('Chat Dockerizing') {
            steps {
                sh "docker rmi martinflower/fly:fly_socket"
                dir('./backend/socket'){
                    sh "pwd"
                    sh "chmod 777 gradlew"
                    sh "./gradlew clean build"
                    sh "docker build -t martinflower/fly:fly_socket ."
                }
            }
        }
        stage('Publish') {
            steps {
                sh "echo $PASSWORD | docker login -u $USERNAME --password-stdin"
                sh "docker push martinflower/fly:fly_socket"
                sh "pwd"
            }
        }
        stage('Deploy') {             
            steps {
                sh "docker pull martinflower/fly:fly_socket"
                sh "docker run --rm -d --name fly_socket -p 8080:8080 martinflower/fly:fly_socket"
            }
        }
    }
}
```



#### Dockerfile

```dockerfile
FROM openjdk:8-jdk-alpine
VOLUME /tmp
ARG JAR_FILE=./build/libs/socket-0.0.1-SNAPSHOT.jar
COPY ${JAR_FILE} app.jar
ENTRYPOINT ["java","-jar","/app.jar"]
```



#### GitLab ì—°ë™

Gitlab - Settings - Webhooks

âœ” URL : ì„œë²„url:9090/project/í”„ë¡œì íŠ¸ëª…

âœ” Secret token

âœ” Trigger - Push events

âœ” SSL verification

â¡ Add webhook



### 6. FrontEnd - Next.js

#### .dockerignore

```dockerignore
node_modules

.next

Dockerfile
```



#### Jenkinsfile

APIì„œë²„ì˜ Jenkinsfileì— ì¶”ê°€

```jenkinsefile
pipeline {
    agent any

    stages {
        stage('Init') {
            steps {
                sh "docker stop fly_be"
                sh "docker stop fly_fe"
            }
        }
        stage('Backend Dockerizing') {
            steps {
                sh "docker rmi martinflower/fly:fly_be"
                dir('./backend/fly'){
                    sh "pwd"
                    sh "chmod 777 gradlew"
                    sh "./gradlew clean build"
                    sh "docker build -t martinflower/fly:fly_be ."
                }
            }
        }
        stage('Backend : Publish & Deploy') {
            steps {
                sh "echo $PASSWORD | docker login -u $USERNAME --password-stdin"
                sh "docker push martinflower/fly:fly_be"
                sh "docker pull martinflower/fly:fly_be"
                sh "docker run --rm -d --name fly_be -p 8080:8080 martinflower/fly:fly_be"
            }
        }
        stage('Frontend Dockerizing') {
            steps {
                sh "docker rmi martinflower/fly:fly_fe"
                dir('./frontend'){
                    sh "docker build -t martinflower/fly:fly_fe ."
                }
            }
        }
        stage('Frontend : Publish & Deploy') {
            steps {
                sh "echo $PASSWORD | docker login -u $USERNAME --password-stdin"
                sh "docker push martinflower/fly:fly_fe"
                sh "docker pull martinflower/fly:fly_fe"
                sh "docker run --rm -d --name fly_fe -p 3000:3000 martinflower/fly:fly_fe"
            }
        }
    }
}
```



#### Dockerfile

```dockerfile
FROM node:16-alpine

WORKDIR /frontend

COPY package.json package-lock.json ./

RUN npm i

COPY . ./

RUN npm run build

EXPOSE 3000

CMD ["npm", "start"]
```



### 7. Nginx ì„¤ì •

**volume mountí•˜ì—¬ Nginx Container ë„ìš°ê¸°**

SSL ì¸ì¦ì„œëŠ” etc/letsencryptìœ„ì¹˜ì— ì¡´ì¬í•œë‹¤.

```shell
docker container run --name nginxserver -d -p 80:80 -p 443:443 -v /etc/letsencrypt:/etc/letsencrypt -v /var/www:/var/www nginx
```



**Containerì—ì„œ ì„¤ì • íŒŒì¼ ìˆ˜ì •**

```shell
docker exec -it nginxserver /bin/bash
cd etc/nginx/conf.d
apt-get update
apt install vim-gtk -y
vi default.conf
```



#### API ì„œë²„

**default.conf**

```conf
server {
    listen       80;
    listen  [::]:80;
    server_name  localhost;

    location / {
        root   /usr/share/nginx/html;
        index  index.html index.htm;
    }

    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    listen [::]:443;
    server_name APIì„œë²„ë„ë©”ì¸;
    server_tokens off;

    ssl_certificate /etc/letsencrypt/live/APIì„œë²„ë„ë©”ì¸/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/APIì„œë²„ë„ë©”ì¸/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location / {
    	root /usr/share/nginx/html;
        proxy_pass http://APIì„œë²„ë„ë©”ì¸:3000;
        proxy_set_header    Host                $http_host;
        proxy_set_header    X-Real-IP           $remote_addr;
        proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;
    }
    location /api {
        proxy_pass http://APIì„œë²„ë„ë©”ì¸:8080;
    }
    location /socket {
        proxy_pass http://Socketì„œë²„ë„ë©”ì¸:8080;
    }
    location /chatSocket {
	proxy_pass http://Socketì„œë²„ë„ë©”ì¸:8080;
	proxy_http_version 1.1;
	proxy_set_header Upgrade $http_upgrade;
	proxy_set_header Connection "Upgrade";
	proxy_set_header Host $host;
    }
}
```

**âœ” ë„ë©”ì¸ ì¶”ê°€ì— ë”°ë¥¸ `server_name flowerlikeu.com www.flowerlikeu.com`**  ë¸”ë¡ ì¶”ê°€



#### Socket ì„œë²„

**default.conf**

```conf
server {
    listen       80;
    listen  [::]:80;
    server_name  localhost;

    location / {
        root   /usr/share/nginx/html;
        index  index.html index.htm;
    }

    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    listen [::]:443;
    server_name Socketì„œë²„ë„ë©”ì¸;
    server_tokens off;

    ssl_certificate /etc/letsencrypt/live/Socketì„œë²„ë„ë©”ì¸/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/Socketì„œë²„ë„ë©”ì¸/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location /socket {
	root /usr/share/nginx/html;
	proxy_pass http://Socketì„œë²„ë„ë©”ì¸:8080;
	proxy_set_header    Host                $http_host;
	proxy_set_header    X-Real-IP           $remote_addr;
	proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;
    }
    location /chatSocket {
	proxy_http_version 1.1;
	proxy_set_header Upgrade $http_upgrade;
	proxy_set_header Connection "Upgrade";
	proxy_set_header Proxy "";
	proxy_set_header Host $http_host;
	proxy_pass http://Socketì„œë²„ë„ë©”ì¸:8080;
    }
}
```
